## Patterns in taxi data

The goal of our analysis is to see trends in rider usage in relationship with changes in the weather. In order to make claims about these relationships, we need to limit other components that may influence taxi ridership. Therefore, we explored variations in taxi usage based on hour of the day, day of the week, and month of the year. For example, it doesn't make sense to compare a Wednesday at 3am to peak rush hour traffic Thursday at 5pm. We can't say an increase in ridership is at all related to weather because there is a baseline difference between these times. We must establish a baseline "normal" in taxi ridership in order to have more consistent comparisons. 

```{r}
#| echo: false
#| message: false
#| warning: false
library(arrow)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(RColorBrewer)
library(lubridate)
library(ggridges)

base_color <- brewer.pal(n = 3, name = "Set2")[1]
classic <- theme_set(theme_minimal())

df <- read_parquet("../../data/complete_weather_and_taxi_data.parquet")
df <- df |> 
  filter(date >= as.Date("2021-10-02"))
```

### Distance of trip only shows hourly trend 

### Variations in ridership based on business days and hours

- by hour and day of week (color coded week weekend)

**Conclusion**: we will move forward with rush hour data only. 

```{r}

all_dates <- seq.Date(as.Date("2021-10-01"), as.Date("2024-12-31"), by = "day")
us_holidays <- as.Date(holidayNYSE(c(2021:2024)))

get_columbus_day <- function(year) {
  october_dates <- seq.Date(as.Date(paste(year, "10-01", sep = "-")), as.Date(paste(year, "10-31", sep = "-")), by = "day")
  mondays <- october_dates[weekdays(october_dates) == "Monday"]
  mondays[2]
}
get_black_friday <- function(year) {
  november_dates <- seq.Date(as.Date(paste(year, "11-01", sep = "-")), as.Date(paste(year, "11-30", sep = "-")), by = "day")
  thursdays <- november_dates[weekdays(november_dates) == "Thursday"]
  thanksgiving <- thursdays[4] 
  thanksgiving + 1 
}
christmaseve_to_new_years <- as.Date(unlist(lapply(2021:2024, function(year) {
  seq.Date(as.Date(paste(year, "12-24", sep = "-")), as.Date(paste(year, "12-31", sep = "-")), by = "day")
})))

columbus_days <- as.Date(sapply(2021:2024, get_columbus_day))
black_fridays <- as.Date(sapply(2021:2024, get_black_friday))

working_days <- all_dates[
  !weekdays(all_dates) %in% c("Saturday", "Sunday") & 
  !(all_dates %in% us_holidays) & 
  !(all_dates %in% columbus_days) & 
  !(all_dates %in% black_fridays) & 
  !(all_dates %in% christmaseve_to_new_years) & 
  (format(as.Date(all_dates), "%m-%d") != "11-11")
]

df$working_day <- ifelse(df$date %in% working_days, T, F)
df$rush_hour <- ifelse(df$working_day==T & df$hour %in% c(7,8,9,17,18,19), T, F)
df <- df |> filter(rush_hour==T)
```

### Day of week and seasonal patterns

- boxplot by month and day of week

### (Optional) Exploring morning and evening rush hour... 

- perhaps morning vs evening rush
